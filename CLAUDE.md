# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

- `npm run dev` - Start development server on http://localhost:3000
- `npm run build` - Build for production
- `npm run start` - Start production server
- `npm run lint` - Run ESLint for code quality checks

## Project Architecture

This is a Next.js 15 real estate platform for Domera, a pre-construction property investment platform operating in Uruguay. The project uses the App Router with TypeScript, Tailwind CSS v4, and Supabase as backend.

### Stack Tecnol√≥gico Confirmado (Agosto 2025)

- **Backend**: Supabase (PostgreSQL + Real-time + Auth + Storage)
- **Autenticaci√≥n**: NextAuth.js integrado con Supabase
- **Notificaciones**: Solo email con Resend
- **Real-time**: Supabase Real-time channels (no Socket.io)
- **Validaci√≥n**: M√∫ltiples capas (Middleware ‚Üí API/Server Actions ‚Üí Data Access Layer)

### Key Architecture Patterns

- **App Router Structure**: Uses Next.js 15 App Router with file-based routing
- **Component Architecture**: Modular components in `src/components/` with clear separation of concerns
- **Styling**: Tailwind CSS v4 with custom brand colors and responsive design
- **State Management**: React useState for local component state, Supabase for global state
- **Images**: Static assets in `public/` folder, uses Next.js Image component for optimization
- **Database**: Supabase PostgreSQL with Row Level Security (RLS)

### Core Routes and Pages

- `/` - Homepage with Hero, Partners, Projects, Process sections
- `/projects` - Project listing page
- `/projects/[id]` - Dynamic project detail page with gallery, description, amenities
- `/projects/[id]/units/[unitId]` - Individual unit detail page
- `/dashboard` - Organization dashboard
- `/userDashboard` - User dashboard for active operations

### Component Structure

**Layout Components:**

- `Header.tsx` - Navigation with responsive menu
- `Footer.tsx` - Contact information and links
- `Hero.tsx` - Main hero section with statistics

**Feature Components:**

- `ProjectCard.tsx` - Reusable project card with hover effects and custom SVG styling
- `Projects.tsx` - Project grid container
- `Partners.tsx` - Partner logos section
- `Process.tsx` - Investment process steps

### Business Model y Restricciones Importantes

#### Restricciones de Negocio:

- **NO pagos internos**: Solo gesti√≥n de comprobantes como documentos
- **NO registro p√∫blico**: Solo admins crean usuarios, owners agregan roles
- **Una operaci√≥n activa por usuario**: Sistema de bloqueo estricto
- **NO eliminaci√≥n de datos**: Solo correcciones con historial
- **NO firma digital integrada**: Solo enlaces externos a Abitab/Agesic
- **NO chat en vivo ni SMS**: Solo notificaciones email

#### Usuarios y Roles (RBAC):

- **Admin Domera**: Gesti√≥n completa, onboarding, compliance
- **Organization Owner**: Gesti√≥n de desarrolladora
- **Sales Manager**: Gesti√≥n de ventas
- **Finance**: Gesti√≥n financiera
- **Site Manager**: Gesti√≥n de obra
- **Professional**: Escriban√≠a y Contadur√≠a (externos)
- **User**: Comprador/Inversor

#### Flujo de Operaciones:

1. Usuario selecciona unidad (apartamento, cochera , bodega, etc)
2. Se genera una operaci√≥n √∫nica (bloquea al usuario para otras)
3. Se asigna profesional y se generan documentos
4. Usuario descarga, firma externamente (Abitab/Agesic) y sube documentos
5. Profesional valida documentos y proceso
6. Operaci√≥n se completa y usuario queda libre para nueva operaci√≥n

### Data Access Layer y Validaciones

#### Sistema de Validaciones en 3 Capas:

```typescript
// 1. Middleware de rutas protegidas
// 2. Validaciones en Server Actions/API Routes
// 3. Validaciones finales en Data Access Layer
```

#### Principios de Datos:

- **Auditor√≠a completa**: Cada acci√≥n queda registrada en audit_logs
- **Sin eliminaciones**: Sistema de correcciones con historial
- **Una operaci√≥n por usuario**: Control estricto de estado
- **Documentos seguros**: Tipos diferenciados y acceso controlado

### Key Technical Details

- **TypeScript Configuration**: Strict mode enabled with path aliases `@/*` for `src/*`
- **Styling Approach**: Uses Tailwind utility classes with custom brand colors (domera-blue: #2563eb, domera-navy: #1e3a8a)
- **Image Handling**: regular img tags
- **Responsive Design**: Mobile-first approach with md: and lg: breakpoints
- **Animations**: CSS transitions and hover effects, uses Framer Motion library
- **Database Security**: Row Level Security (RLS) configurado por rol y organizaci√≥n

### React Patterns and Best Practices

#### üö´ **AVOID useEffect - Critical Guidelines**

**Core Philosophy**: "Effects are an escape hatch from the React paradigm. Don't rush to add Effects."

**What NOT to use Effects for:**

- ‚ùå **Transforming data for rendering** - Calculate during render instead
- ‚ùå **Handling user events** - Use event handlers directly
- ‚ùå **Data fetching on component mount** - Use framework patterns (Server Components, etc.)
- ‚ùå **Synchronizing state between components** - Lift state up or use shared state

**Preferred Patterns for Domera Platform:**

```typescript
// ‚úÖ GOOD: Calculate derived state during rendering
function ProjectList({ projects, selectedFilters }) {
  const filteredProjects = projects.filter(project =>
    matchesFilters(project, selectedFilters)
  );
  return <div>{/* render */}</div>;
}

// ‚úÖ GOOD: Handle user interactions in event handlers
function FavoriteButton({ unitId }) {
  async function handleToggle() {
    const result = await toggleFavorite(unitId);
    if (result.success) {
      // Revalidate or redirect
    }
  }
  return <button onClick={handleToggle}>Toggle</button>;
}

// ‚úÖ GOOD: Use useMemo for expensive calculations only
function ExpensiveCalculation({ largeDataSet }) {
  const expensiveValue = useMemo(() =>
    complexCalculation(largeDataSet), [largeDataSet]
  );
  return <div>{expensiveValue}</div>;
}

// ‚ùå AVOID: Chaining Effects or state synchronization
// Instead: lift state up or use derived state
```

**Data Fetching Strategy:**

- **Server Components**: Fetch data at page level
- **Server Actions**: Handle form submissions and mutations
- **Event Handlers**: Handle user-triggered data changes
- **Cache revalidation**: Use `revalidatePath()` after mutations

**State Management Principles:**

- Store minimal state (IDs instead of objects)
- Calculate derived state during rendering
- Use "key" prop to reset component state
- Lift state up for component synchronization

### Backend-First Development Strategy

#### üéØ **CORE FOCUS: Backend Functionality**

**Development Priority:**

1. **Server Actions** - Core business logic and data mutations
2. **API Endpoints** - When needed for specific integrations
3. **Data Access Layer** - Secure CRUD operations with validation
4. **Frontend** - Will be implemented later by specialized frontend developers

**Backend Design Principles:**

- ‚úÖ **Simplicity for Frontend**: Easy-to-use Server Actions with clear interfaces
- ‚úÖ **Security First**: All operations properly authenticated and authorized
- ‚úÖ **No Overcomplexity**: Straightforward data fetching and CRUD operations
- ‚úÖ **Clear Documentation**: Well-defined interfaces and error handling
- ‚úÖ **Type Safety**: Full TypeScript support for frontend integration

**What Backend Should Provide:**

```typescript
// ‚úÖ GOOD: Simple, secure Server Actions
export async function getUserFavorites(): Promise<FavoriteResult>;
export async function addToFavorites(unitId: string): Promise<FavoriteResult>;
export async function getProjectsWithFeatures(): Promise<ProjectResult>;

// ‚úÖ GOOD: Clear result types
interface FavoriteResult {
  success: boolean;
  data?: FavoriteUnit[];
  error?: string;
}
```

**Security Non-Negotiables:**

- üîí **Authentication**: Every action validates user session
- üîê **Authorization**: Role-based access control (RBAC)
- üõ°Ô∏è **Input Validation**: Zod schemas for all inputs
- üè¢ **Multi-tenant**: Organization-based data isolation
- üìù **Audit Trail**: All changes logged to audit_logs
- üö´ **No Direct DB Access**: Always through DAL with validations

### Esquema de Base de Datos

#### Tablas Principales:

```sql
-- Usuarios y organizaciones
users, organizations, user_roles

-- Proyectos y propiedades
projects, units, unit_types, amenities

-- Operaciones y documentos
operations, operation_steps, documents, document_types

-- Profesionales y validaciones
professionals, professional_assignments, validations

-- Notificaciones y auditor√≠a
notifications, audit_logs, data_corrections
```

#### Tipos de Propiedades:

- Apartamentos, locales comerciales, cocheras, bodegas
- Sistema individual para operaciones (unidad, cochera, etc son 1 operaci√≥n)
- Estados: disponible, reservado, vendido, en_proceso

### Data Patterns (Migraci√≥n Planificada)

- **Actual**: Project data hardcoded in component files
- **Futuro**: Data completamente en Supabase con Server Actions
- Unit filtering implemented with React state for floor, typology, and orientation
- Project data structure includes: title, price, location, date, images, amenities, units

### Important Notes

- The brand is "Domera"
- Uses Inter font from Google Fonts
- Spanish language interface (lang="es")
- Has Projects that operates under "Ley de Vivienda Promovida N¬∞18.795" (Uruguay)
- Currency: USD for all transactions
- Target market: Montevideo areas (Pocitos, Carrasco, La Blanqueada), Maldonado and Punta del Este for now.

### Timeline de Implementaci√≥n

**Fase 1-3** (9-12 d√≠as): Setup Supabase, esquema DB, autenticaci√≥n
**Fase 4-6** (9-12 d√≠as): Sistema de operaciones, documentos, dashboards
**Fase 7-9** (8-11 d√≠as): Real-time, migraci√≥n de datos, seguridad

**Total Estimado**: 26-35 d√≠as

## ‚úÖ ESTADO ACTUAL DE DESARROLLO (Agosto 17, 2025)

### üî• COMPLETADO - FASE 1: Infraestructura Base

#### ‚úÖ 1. Configuraci√≥n de Supabase

- **Archivos creados:**
  - `src/lib/supabase/client.ts` - Cliente browser
  - `src/lib/supabase/server.ts` - Cliente servidor
  - `src/lib/supabase/middleware.ts` - Manejo de sesiones
  - `.env.local.example` - Variables de entorno
- **Estado**: ‚úÖ **COMPLETADO**

#### ‚úÖ 2. Esquema de Base de Datos

- **Archivos creados:**
  - `supabase/schema.sql` - Esquema completo (35 tablas + triggers + indexes)
  - `supabase/rls-policies.sql` - Pol√≠ticas de seguridad RLS por rol
  - `supabase/seed-data.sql` - Datos de prueba completos
- **Caracter√≠sticas implementadas:**
  - üîí Row Level Security (RLS) por rol y organizaci√≥n
  - üìä Sistema de auditor√≠a completo
  - üö´ Sin eliminaci√≥n f√≠sica (solo correcciones)
  - üìã Tipos de entidades: organizations, users, projects, units, operations, documents, professionals
- **Estado**: ‚úÖ **COMPLETADO**

#### ‚úÖ 3. Tipos TypeScript

- **Archivos creados:**
  - `src/types/database.ts` - Tipos completos para todas las entidades
  - `src/types/next-auth.d.ts` - Extensiones para NextAuth
- **Estado**: ‚úÖ **COMPLETADO**

#### ‚úÖ 4. Validaciones Zod

- **Archivos creados:**
  - `src/lib/validations/schemas.ts` - Esquemas Zod para todas las entidades
- **Caracter√≠sticas:**
  - ‚úÖ Validaci√≥n de entrada para CREATE/UPDATE
  - ‚úÖ Esquemas de filtros y paginaci√≥n
  - ‚úÖ Validaciones de archivos y documentos
- **Estado**: ‚úÖ **COMPLETADO**

#### ‚úÖ 5. Data Access Layer (DAL)

- **Archivos creados:**
  - `src/lib/dal/base.ts` - Funciones base y utilities
  - `src/lib/dal/operations.ts` - CRUD de operaciones con validaciones
  - `src/lib/dal/projects.ts` - CRUD de proyectos y unidades
- **Caracter√≠sticas implementadas:**
  - üõ°Ô∏è **3 capas de validaci√≥n**: Middleware ‚Üí Server Actions ‚Üí DAL
  - üìù **Auditor√≠a autom√°tica**: Todos los cambios quedan registrados
  - üîÑ **Sistema de correcciones**: Historial sin eliminaci√≥n
  - ‚ö° **Validaciones de negocio**: Una operaci√≥n activa por usuario
  - üè¢ **Multi-tenant**: Validaci√≥n por organizaci√≥n
- **Estado**: ‚úÖ **COMPLETADO**

### üî• COMPLETADO - FASE 2: Autenticaci√≥n y Autorizaci√≥n

#### ‚úÖ 6. NextAuth.js + Supabase

- **Archivos creados:**
  - `src/lib/auth/config.ts` - Configuraci√≥n NextAuth completa
  - `src/app/api/auth/[...nextauth]/route.ts` - API routes
  - `middleware.ts` - Protecci√≥n de rutas por rol
- **Caracter√≠sticas implementadas:**
  - üîê **Autenticaci√≥n por credenciales** (desarrollo)
  - üé≠ **7 roles de usuario**: admin, organization_owner, sales_manager, finance_manager, site_manager, professional, user
  - üè¢ **Multi-organizaci√≥n**: Usuarios pueden pertenecer a m√∫ltiples organizaciones
  - üõ°Ô∏è **Protecci√≥n autom√°tica**: Middleware que valida roles por ruta
- **Estado**: ‚úÖ **COMPLETADO**

#### ‚úÖ 7. Hooks de Autenticaci√≥n

- **Archivos creados:**
  - `src/hooks/useAuth.ts` - Hooks personalizados completos
  - `src/components/providers/SessionProvider.tsx` - Provider de sesi√≥n
- **Hooks disponibles:**
  - `useAuth()` - Estado de autenticaci√≥n
  - `useHasRole(role, orgId?)` - Verificar rol espec√≠fico
  - `useIsAdmin()` - Verificar si es admin
  - `useRequireAuth()` - Requerir autenticaci√≥n
  - `useRequireRole(role, orgId?)` - Requerir rol espec√≠fico
  - `useBelongsToOrganization(orgId)` - Verificar membres√≠a
- **Estado**: ‚úÖ **COMPLETADO**

#### ‚úÖ 8. P√°gina de Login Actualizada

- **Archivos modificados:**
  - `src/app/login/page.tsx` - Integrada con NextAuth
  - `src/app/layout.tsx` - SessionProvider incluido
- **Caracter√≠sticas:**
  - üîÑ **Auto-redirect**: Redirecci√≥n basada en rol
  - ‚ö†Ô∏è **Manejo de errores**: Mensajes de error claros
  - üîí **Estados de carga**: UI disabled durante autenticaci√≥n
  - üì± **Responsive**: Mantiene dise√±o original
- **Estado**: ‚úÖ **COMPLETADO**

#### ‚úÖ 9. Correcci√≥n de Variables de Entorno

- **Archivos corregidos:**
  - `.env` ‚Üí `.env.local` - Renombrado para Next.js
  - `NEXTAUTH_SECRET` - Configurado con valor v√°lido
  - `NEXTAUTH_URL` - Actualizado a puerto 3000
- **Estado**: ‚úÖ **COMPLETADO**

### ‚úÖ COMPLETADO - FASE 3: Setup Base de Datos

#### ‚úÖ 10. Integraci√≥n Prisma y Migraci√≥n

- **Archivos creados:**
  - `prisma/schema.prisma` - Esquema Prisma completo con modelos
  - `prisma/migrations/20250817195254_init/` - Migraci√≥n inicial aplicada
  - `scripts/seed-database.js` - Script de siembra con datos completos
  - `scripts/test-db-connection.js` - Validaci√≥n de conexi√≥n
- **Funcionalidades:**
  - üóÉÔ∏è **Prisma ORM**: Configurado y conectado a Supabase
  - üì¶ **Migraci√≥n exitosa**: Esquema aplicado con directUrl
  - üå± **Datos de prueba**: Base de datos poblada con:
    - Organizaci√≥n: Domera Development
    - Usuario admin: prueba@test.com (Password: Password.123)
    - 2 proyectos: Torres del R√≠o + Urban Living Cord√≥n
    - 5 unidades con diferentes tipos y estados
    - 1 profesional verificado (escribania)
  - ‚úÖ **Prisma Client**: Listo
  - üîí **RoleType enum**: Listo
- **Estado**: ‚úÖ **COMPLETADO**

#### ‚úÖ 11. Sistema de Autenticaci√≥n con Contrase√±as Seguras

- **Archivos creados/modificados:**
  - `src/lib/auth/password.ts` - Utilidades de hashing con bcryptjs
  - `src/lib/validations/schemas.ts` - Validaciones de contrase√±as y login
  - `src/lib/auth/config.ts` - NextAuth actualizado con verificaci√≥n de BD
  - `scripts/seed-database.js` - Script actualizado con m√∫ltiples usuarios
  - `scripts/test-authentication.js` - Test de verificaci√≥n del sistema
- **Funcionalidades:**
  - üîê **Hash seguro**: bcryptjs con salt rounds 12 (nivel producci√≥n)
  - üé≠ **M√∫ltiples usuarios**: 4 usuarios de prueba con roles diferentes
  - ‚úÖ **Validaci√≥n robusta**: Zod schemas para contrase√±as y login
  - üîí **Verificaci√≥n completa**: NextAuth verifica contra BD hasheada
  - üß™ **Testing**: Script de pruebas autom√°ticas del sistema
- **Usuarios de prueba (Password: Password.123):**
  - `admin@domera.uy` - Super Admin
  - `owner@domera.uy` - Organization Owner
  - `prueba@test.com` - Admin (usuario original)
  - `user@domera.uy` - Cliente Regular
- **Estado**: ‚úÖ **COMPLETADO - SIN SHORTCUTS DE DESARROLLO**

### ‚è≥ PENDIENTE - FASE 4: Sistema de Operaciones

#### üîÑ Pr√≥ximo: Server Actions y API Routes

- **Pendiente**: Migrar datos hardcodeados a Server Actions
- **Pendiente**: Crear API routes para operaciones
- **Pendiente**: Implementar hooks para operaciones activas

### ‚è≥ PENDIENTE - FASES 4-9

#### Pendiente: Sistema de Documentos

#### Pendiente: Real-time con Supabase

#### Pendiente: Migraci√≥n completa de datos

#### Pendiente: Dashboard funcional

#### Pendiente: Gesti√≥n de profesionales

- Ensure we use prisma and not bypass it with direct supabase connections in order to have accurate process.
- remember our dev server runs on port 3000
